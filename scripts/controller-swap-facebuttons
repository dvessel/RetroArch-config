#!/usr/bin/env zsh
#
# swap a b and x y buttons on .rmp files.
#
# Usage: controller-swap-facebuttons [path]
#

awk '
{
    # Store the entire line in an array
    lines[NR] = $0

    # Check if the line is one of the target buttons
    if ($0 ~ /^input_player1_btn_[abxy]/) {
        # Extract the key name
        match($0, /^input_player1_btn_[a-z]+/)
        key = substr($0, RSTART, RLENGTH)

        # Extract the value inside the quotes
        match($0, /"([^"]*)"/)
        val = substr($0, RSTART+1, RLENGTH-2)

        # Save the value and line number for the specific keys
        if (key == "input_player1_btn_a") { vA = val; iA = NR }
        if (key == "input_player1_btn_b") { vB = val; iB = NR }
        if (key == "input_player1_btn_x") { vX = val; iX = NR }
        if (key == "input_player1_btn_y") { vY = val; iY = NR }
    }
}
END {
    # Perform the swaps if both keys were found
    if (iA && iB) {
        replace(iA, vB)
        replace(iB, vA)
    }
    if (iX && iY) {
        replace(iX, vY)
        replace(iY, vX)
    }

    # Print all lines
    for (i = 1; i <= NR; i++) {
        print lines[i]
    }
}

function replace(idx, new_val, parts) {
    # Split the line by the quote character
    split(lines[idx], parts, "\"")
    # Reconstruct line with the new value (parts[1] is key, parts[3] is trailing text)
    lines[idx] = parts[1] "\"" new_val "\"" parts[3]
}
' $1 > $1.tmp && mv $1.tmp $1
